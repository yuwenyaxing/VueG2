{"version":3,"sources":["../../src/map/map.ts"],"names":["CoordinateSystem","MapServiceEvent","TYPES","Map","DOM","inject","injectable","Viewport","EventMap","mapmove","camerachange","zoomchange","dragging","MapTheme","LNGLAT_OFFSET_ZOOM_THRESHOLD","L7MapService","MapConfig","IGlobalConfigService","ILogService","ICoordinateSystemService","IEventEmitter","map","viewport","markerContainer","cameraChangedCallback","$mapContainer","handleCameraChanged","getCenter","lat","lng","syncWithMapCamera","bearing","getBearing","center","viewportHeight","transform","height","pitch","getPitch","viewportWidth","width","zoom","getZoom","cameraHeight","coordinateSystemService","setCoordinateSystem","LNGLAT_OFFSET","LNGLAT","container","getCanvasContainer","create","setAttribute","type","handle","indexOf","eventEmitter","on","off","getContainer","size","setZoom","lnglat","setCenter","getBounds","toArray","getMinZoom","getMaxZoom","rotation","setBearing","option","eventData","zoomIn","zoomOut","setPitch","p","panTo","pixel","bound","fitBoundsOptions","fitBounds","max","setMaxZoom","min","setMinZoom","doubleClickZoom","enable","disable","dragEnable","dragPan","rotateEnable","dragRotate","keyboardEnable","keyboard","zoomEnable","scrollZoom","flyTo","style","setStyle","getMapStyle","unproject","project","altitude","Error","rotate","scale","origin","x","y","z","config","id","attributionControl","mapInstance","rest","creatAmapContainer","removeAllListeners","remove","name","args","emit","once","renderCanvas","getCanvas","layersPng","toDataURL","callback","$wrapper","document","getElementById"],"mappings":"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","sourcesContent":["/**\n * MapboxService\n */\nimport {\n  Bounds,\n  CoordinateSystem,\n  ICoordinateSystemService,\n  IGlobalConfigService,\n  ILngLat,\n  ILogService,\n  IMapConfig,\n  IMapService,\n  IMercator,\n  IPoint,\n  IStatusOptions,\n  IViewport,\n  MapServiceEvent,\n  MapStyle,\n  TYPES,\n} from '@antv/l7-core';\nimport { Map } from '@antv/l7-map';\nimport { DOM } from '@antv/l7-utils';\nimport { mat4, vec2, vec3 } from 'gl-matrix';\nimport { inject, injectable } from 'inversify';\n\nimport Viewport from './Viewport';\nconst EventMap: {\n  [key: string]: any;\n} = {\n  mapmove: 'move',\n  camerachange: 'move',\n  zoomchange: 'zoom',\n  dragging: 'drag',\n};\nimport { MapTheme } from './theme';\n\nconst LNGLAT_OFFSET_ZOOM_THRESHOLD = 12;\n/**\n * AMapService\n */\n@injectable()\nexport default class L7MapService implements IMapService<Map> {\n  public map: Map;\n\n  @inject(TYPES.MapConfig)\n  private readonly config: Partial<IMapConfig>;\n\n  @inject(TYPES.IGlobalConfigService)\n  private readonly configService: IGlobalConfigService;\n\n  @inject(TYPES.ILogService)\n  private readonly logger: ILogService;\n  @inject(TYPES.ICoordinateSystemService)\n  private readonly coordinateSystemService: ICoordinateSystemService;\n\n  @inject(TYPES.IEventEmitter)\n  private eventEmitter: any;\n  private viewport: Viewport;\n  private markerContainer: HTMLElement;\n  private cameraChangedCallback: (viewport: IViewport) => void;\n  private $mapContainer: HTMLElement | null;\n\n  // init\n  public addMarkerContainer(): void {\n    const container = this.map.getCanvasContainer();\n    this.markerContainer = DOM.create('div', 'l7-marker-container', container);\n    this.markerContainer.setAttribute('tabindex', '-1');\n  }\n\n  public getMarkerContainer(): HTMLElement {\n    return this.markerContainer;\n  }\n\n  //  map event\n  public on(type: string, handle: (...args: any[]) => void): void {\n    if (MapServiceEvent.indexOf(type) !== -1) {\n      this.eventEmitter.on(type, handle);\n    } else {\n      // 统一事件名称\n      this.map.on(EventMap[type] || type, handle);\n    }\n  }\n  public off(type: string, handle: (...args: any[]) => void): void {\n    this.map.off(EventMap[type] || type, handle);\n  }\n\n  public getContainer(): HTMLElement | null {\n    return this.map.getContainer();\n  }\n\n  public getMapCanvasContainer(): HTMLElement {\n    return this.map.getCanvasContainer() as HTMLElement;\n  }\n\n  public getSize(): [number, number] {\n    const size = this.map.transform;\n    return [size.width, size.height];\n  }\n  // get mapStatus method\n\n  public getType() {\n    return 'default';\n  }\n\n  public getZoom(): number {\n    return this.map.getZoom();\n  }\n\n  public setZoom(zoom: number) {\n    return this.map.setZoom(zoom);\n  }\n\n  public getCenter(): ILngLat {\n    return this.map.getCenter();\n  }\n\n  public setCenter(lnglat: [number, number]): void {\n    this.map.setCenter(lnglat);\n  }\n\n  public getPitch(): number {\n    return this.map.getPitch();\n  }\n\n  public getRotation(): number {\n    return this.map.getBearing();\n  }\n\n  public getBounds(): Bounds {\n    return this.map.getBounds().toArray() as Bounds;\n  }\n\n  public getMinZoom(): number {\n    return this.map.getMinZoom();\n  }\n\n  public getMaxZoom(): number {\n    return this.map.getMaxZoom();\n  }\n\n  public setRotation(rotation: number): void {\n    this.map.setBearing(rotation);\n  }\n\n  public zoomIn(option?: any, eventData?: any): void {\n    this.map.zoomIn(option, eventData);\n  }\n  public zoomOut(option?: any, eventData?: any): void {\n    this.map.zoomOut(option, eventData);\n  }\n  public setPitch(pitch: number) {\n    return this.map.setPitch(pitch);\n  }\n\n  public panTo(p: [number, number]): void {\n    this.map.panTo(p);\n  }\n\n  public panBy(pixel: [number, number]): void {\n    this.panTo(pixel);\n  }\n\n  public fitBounds(bound: Bounds, fitBoundsOptions?: any): void {\n    this.map.fitBounds(bound, fitBoundsOptions);\n  }\n\n  public setMaxZoom(max: number): void {\n    this.map.setMaxZoom(max);\n  }\n\n  public setMinZoom(min: number): void {\n    this.map.setMinZoom(min);\n  }\n  public setMapStatus(option: Partial<IStatusOptions>): void {\n    if (option.doubleClickZoom === true) {\n      this.map.doubleClickZoom.enable();\n    }\n    if (option.doubleClickZoom === false) {\n      this.map.doubleClickZoom.disable();\n    }\n    if (option.dragEnable === false) {\n      this.map.dragPan.disable();\n    }\n    if (option.dragEnable === true) {\n      this.map.dragPan.enable();\n    }\n    if (option.rotateEnable === false) {\n      this.map.dragRotate.disable();\n    }\n    if (option.dragEnable === true) {\n      this.map.dragRotate.enable();\n    }\n    if (option.keyboardEnable === false) {\n      this.map.keyboard.disable();\n    }\n    if (option.keyboardEnable === true) {\n      this.map.keyboard.enable();\n    }\n    if (option.zoomEnable === false) {\n      this.map.scrollZoom.disable();\n    }\n    if (option.zoomEnable === true) {\n      this.map.scrollZoom.enable();\n    }\n  }\n\n  public setZoomAndCenter(zoom: number, center: [number, number]): void {\n    this.map.flyTo({\n      zoom,\n      center,\n    });\n  }\n\n  public setMapStyle(style: any): void {\n    this.map.setStyle(this.getMapStyle(style));\n  }\n  // TODO: 计算像素坐标\n  public pixelToLngLat(pixel: [number, number]): ILngLat {\n    return this.map.unproject(pixel);\n  }\n\n  public lngLatToPixel(lnglat: [number, number]): IPoint {\n    return this.map.project(lnglat);\n  }\n\n  public containerToLngLat(pixel: [number, number]): ILngLat {\n    return this.map.unproject(pixel);\n  }\n\n  public lngLatToContainer(lnglat: [number, number]): IPoint {\n    return this.map.project(lnglat);\n  }\n  public lngLatToMercator(\n    lnglat: [number, number],\n    altitude: number,\n  ): IMercator {\n    throw new Error('not implement');\n  }\n  public getModelMatrix(\n    lnglat: [number, number],\n    altitude: number,\n    rotate: [number, number, number],\n    scale: [number, number, number] = [1, 1, 1],\n    origin: IMercator = { x: 0, y: 0, z: 0 },\n  ): number[] {\n    throw new Error('not implement');\n  }\n\n  public async init(): Promise<void> {\n    const {\n      id = 'map',\n      attributionControl = false,\n      style = 'light',\n      rotation = 0,\n      mapInstance,\n      ...rest\n    } = this.config;\n\n    this.viewport = new Viewport();\n\n    if (mapInstance) {\n      // @ts-ignore\n      this.map = mapInstance;\n      this.$mapContainer = this.map.getContainer();\n    } else {\n      this.$mapContainer = this.creatAmapContainer(id);\n      // @ts-ignore\n      this.map = new Map({\n        container: this.$mapContainer,\n        style: this.getMapStyle(style),\n        bearing: rotation,\n        ...rest,\n      });\n    }\n    this.map.on('load', this.handleCameraChanged);\n    this.map.on('move', this.handleCameraChanged);\n\n    // 不同于高德地图，需要手动触发首次渲染\n    this.handleCameraChanged();\n  }\n\n  public destroy() {\n    this.eventEmitter.removeAllListeners();\n    if (this.map) {\n      this.map.remove();\n      this.$mapContainer = null;\n    }\n  }\n  public emit(name: string, ...args: any[]) {\n    this.eventEmitter.emit(name, ...args);\n  }\n  public once(name: string, ...args: any[]) {\n    this.eventEmitter.once(name, ...args);\n  }\n\n  public getMapContainer() {\n    return this.$mapContainer;\n  }\n\n  public exportMap(type: 'jpg' | 'png'): string {\n    const renderCanvas = this.map.getCanvas();\n    const layersPng =\n      type === 'jpg'\n        ? (renderCanvas?.toDataURL('image/jpeg') as string)\n        : (renderCanvas?.toDataURL('image/png') as string);\n    return layersPng;\n  }\n  public onCameraChanged(callback: (viewport: IViewport) => void): void {\n    this.cameraChangedCallback = callback;\n  }\n\n  private handleCameraChanged = () => {\n    const { lat, lng } = this.map.getCenter();\n\n    // resync\n    this.viewport.syncWithMapCamera({\n      bearing: this.map.getBearing(),\n      center: [lng, lat],\n      viewportHeight: this.map.transform.height,\n      pitch: this.map.getPitch(),\n      viewportWidth: this.map.transform.width,\n      zoom: this.map.getZoom(),\n      // mapbox 中固定相机高度为 viewport 高度的 1.5 倍\n      cameraHeight: 0,\n    });\n    // set coordinate system\n    if (this.viewport.getZoom() > LNGLAT_OFFSET_ZOOM_THRESHOLD) {\n      this.coordinateSystemService.setCoordinateSystem(\n        CoordinateSystem.LNGLAT_OFFSET,\n      );\n    } else {\n      this.coordinateSystemService.setCoordinateSystem(CoordinateSystem.LNGLAT);\n    }\n\n    this.cameraChangedCallback(this.viewport);\n  };\n\n  private creatAmapContainer(id: string | HTMLDivElement) {\n    let $wrapper = id as HTMLDivElement;\n    if (typeof id === 'string') {\n      $wrapper = document.getElementById(id) as HTMLDivElement;\n    }\n    return $wrapper;\n  }\n  private getMapStyle(name: MapStyle) {\n    if (typeof name !== 'string') {\n      return name;\n    }\n    return MapTheme[name] ? MapTheme[name] : name;\n  }\n}\n"],"file":"map.js"}