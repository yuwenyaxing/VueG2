{"version":3,"sources":["../../../../src/services/renderer/passes/MultiPassRenderer.ts"],"names":["MultiPassRenderer","TYPES","IPostProcessor","passes","layer","renderFlag","width","height","postProcessor","pass","render","renderModels","resize","config","getType","PassType","PostProcessing","add","init","push","index","splice","length"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;AAAA;;AACA;;AAEA;;;;;;;;;;IA4BqBA,iB,WADpB,4B,UAIE,uBAAOC,aAAMC,cAAb,C;;;SAFOC,M,GAAgC,E;;SAKhCC,K;SACAC,U;SAEAC,K,GAAgB,C;SAEhBC,M,GAAiB,C;;;;;6BAETH,K,EAAe;AAC7B,WAAKA,KAAL,GAAaA,KAAb;AACD;;;kCAEoBC,U,EAAqB;AACxC,WAAKA,UAAL,GAAkBA,UAAlB;AACD;;;oCAEsB;AACrB,aAAO,KAAKA,UAAZ;AACD;;;uCAEyB;AACxB,aAAO,KAAKG,aAAZ;AACD;;;;;;;;;;;uDAGoB,KAAKL,M;;;;;;;;;;;AAAbM,gBAAAA,I;;uBACHA,IAAI,CAACC,MAAL,CAAY,KAAKN,KAAjB,C;;;;;;;;;;;;;;;;;;;;;;;;AAER,qBAAKA,KAAL,CAAWO,YAAX;;;;;;;;;;;;;;;;;;2BAIYL,K,EAAeC,M,EAAgB;AAC3C,UAAI,KAAKD,KAAL,KAAeA,KAAf,IAAwB,KAAKC,MAAL,KAAgBA,MAA5C,EAAoD;AAClD,aAAKC,aAAL,CAAmBI,MAAnB,CAA0BN,KAA1B,EAAiCC,MAAjC;AACA,aAAKD,KAAL,GAAaA,KAAb;AACA,aAAKC,MAAL,GAAcA,MAAd;AACD;AACF;;;wBAEaE,I,EAAgBI,M,EAAqB;AACjD,UAAIJ,IAAI,CAACK,OAAL,OAAmBC,6BAASC,cAAhC,EAAgD;AAC9C,aAAKR,aAAL,CAAmBS,GAAnB,CACER,IADF,EAEE,KAAKL,KAFP,EAGES,MAHF;AAKD,OAND,MAMO;AACLJ,QAAAA,IAAI,CAACS,IAAL,CAAU,KAAKd,KAAf,EAAsBS,MAAtB;AACA,aAAKV,MAAL,CAAYgB,IAAZ,CAAiBV,IAAjB;AACD;AACF;;;2BAEgBA,I,EAAgBI,M,EAAoBO,K,EAAe;AAClEX,MAAAA,IAAI,CAACS,IAAL,CAAU,KAAKd,KAAf,EAAsBS,MAAtB;AACA,WAAKV,MAAL,CAAYkB,MAAZ,CAAmBD,KAAnB,EAA0B,CAA1B,EAA6BX,IAA7B;AACD;;;8BAEgB;AACf,WAAKN,MAAL,CAAYmB,MAAZ,GAAqB,CAArB;AACD","sourcesContent":["import { inject, injectable } from 'inversify';\nimport { TYPES } from '../../../types';\nimport { ILayer } from '../../layer/ILayerService';\nimport {\n  IMultiPassRenderer,\n  IPass,\n  IPostProcessingPass,\n  IPostProcessor,\n  PassType,\n} from '../IMultiPassRenderer';\n\n/**\n * ported from Three.js EffectComposer\n * @example\n * const renderer = new MultiPassRenderer([\n *   new ClearPass(),\n *   new RenderPass({\n *     models: [\n *       new Model(),\n *       new Model(),\n *     ],\n *   }),\n *   new CopyPass({\n *     renderToScreen: true,\n *   }),\n *   new TAAPass(),\n * ]);\n * renderer.render();\n * @see https://yuque.antfin-inc.com/yuqi.pyq/fgetpa/apuvbf#dRM8W\n */\n@injectable()\nexport default class MultiPassRenderer implements IMultiPassRenderer {\n  private passes: Array<IPass<unknown>> = [];\n\n  @inject(TYPES.IPostProcessor)\n  private postProcessor: IPostProcessor;\n\n  private layer: ILayer;\n  private renderFlag: boolean;\n\n  private width: number = 0;\n\n  private height: number = 0;\n\n  public setLayer(layer: ILayer) {\n    this.layer = layer;\n  }\n\n  public setRenderFlag(renderFlag: boolean) {\n    this.renderFlag = renderFlag;\n  }\n\n  public getRenderFlag() {\n    return this.renderFlag;\n  }\n\n  public getPostProcessor() {\n    return this.postProcessor;\n  }\n\n  public async render() {\n    for (const pass of this.passes) {\n      await pass.render(this.layer);\n    }\n    this.layer.renderModels();\n    // await this.postProcessor.render(this.layer);\n  }\n\n  public resize(width: number, height: number) {\n    if (this.width !== width || this.height !== height) {\n      this.postProcessor.resize(width, height);\n      this.width = width;\n      this.height = height;\n    }\n  }\n\n  public add<T>(pass: IPass<T>, config?: Partial<T>) {\n    if (pass.getType() === PassType.PostProcessing) {\n      this.postProcessor.add<T>(\n        pass as IPostProcessingPass<T>,\n        this.layer,\n        config,\n      );\n    } else {\n      pass.init(this.layer, config);\n      this.passes.push(pass);\n    }\n  }\n\n  public insert<T>(pass: IPass<T>, config: Partial<T>, index: number) {\n    pass.init(this.layer, config);\n    this.passes.splice(index, 0, pass);\n  }\n\n  public destroy() {\n    this.passes.length = 0;\n  }\n}\n"],"file":"MultiPassRenderer.js"}